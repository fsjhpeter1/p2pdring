<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ä¸‰æ¬¡å“¥ P2P ç•«æ¿</title>
  <style>
    canvas { border: 1px solid #000; display: block; margin-top: 10px; }
    footer { margin-top: 20px; font-size: 0.9em; color: #666; }
  </style>
</head>
<body>
  <h2>ä¸‰æ¬¡å“¥ç•«å¸ƒ ğŸ–Œï¸</h2>
  <input id="code" placeholder="é…å°ä»£ç¢¼">
  <button onclick="start()">é–‹å§‹é…å°</button>
  <p id="msg"></p>
  <canvas id="canvas" width="600" height="400"></canvas>
  <footer>Â© FSpeter å‘‚ 2025æ‰€æœ‰</footer>

  <script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    let drawing = false;
    let code = '';
    let lines = [];

    function start() {
      code = document.getElementById('code').value.trim();
      if (!code) return alert('è«‹è¼¸å…¥ä»£ç¢¼');

      fetch('https://p2p-drawing.fsjhpeter1.workers.dev/connect', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ code })
      }).then(() => {
        document.getElementById('msg').innerText = 'âœ… å·²é…å°ï¼Œé–‹å§‹ç•«ç•«ï¼';
        poll();
      });
    }

    function drawLine(x, y) {
      ctx.fillRect(x, y, 2, 2);
    }

    canvas.addEventListener('mousedown', () => drawing = true);
    canvas.addEventListener('mouseup', () => drawing = false);
    canvas.addEventListener('mouseout', () => drawing = false);
    canvas.addEventListener('mousemove', e => {
      if (!drawing || !code) return;
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      drawLine(x, y);

      const line = { x, y, ts: Date.now() };
      fetch('https://p2p-drawing.fsjhpeter1.workers.dev/draw', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ code, line })
      });
    });

    function poll() {
      if (!code) return;
      setInterval(() => {
        fetch(`https://p2p-drawing.fsjhpeter1.workers.dev/draw?code=${code}`)
          .then(res => res.json())
          .then(data => {
            if (JSON.stringify(data) === JSON.stringify(lines)) return;
            lines = data;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            for (let l of lines) drawLine(l.x, l.y);
          });
      }, 1000); // æ¯ç§’åˆ·æ–°
    }
  </script>
</body>
</html>
