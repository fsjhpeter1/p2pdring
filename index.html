<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>P2P ç•«æ¿</title>
  <style>
    body { margin: 0; }
    canvas { border: 2px solid #444; display: block; margin: auto; }
  </style>
</head>
<body>
<canvas id="board" width="800" height="600"></canvas>
<script>
const canvas = document.getElementById('board');
const ctx = canvas.getContext('2d');
let drawing = false;

canvas.addEventListener('mousedown', () => drawing = true);
canvas.addEventListener('mouseup', () => drawing = false);
canvas.addEventListener('mousemove', e => {
  if (!drawing) return;
  const x = e.offsetX;
  const y = e.offsetY;
  draw(x, y);
  send({ x, y });
});

function draw(x, y) {
  ctx.fillStyle = '#333';
  ctx.fillRect(x, y, 4, 4);
}

// === WebRTC + Signaling ===
let peer = new RTCPeerConnection();
let channel = peer.createDataChannel("p2p-draw");

channel.onopen = () => console.log("ğŸ‰ Channel open!");
channel.onmessage = e => {
  const { x, y } = JSON.parse(e.data);
  draw(x, y);
};

function send(data) {
  if (channel && channel.readyState === "open") {
    channel.send(JSON.stringify(data));
  }
}

// === Signaling via Cloudflare Worker ===
const SIGNAL_URL = 'https://ä½ çš„-worker.example.workers.dev';

async function connect(isInitiator) {
  if (isInitiator) {
    const offer = await peer.createOffer();
    await peer.setLocalDescription(offer);
    const id = await post(offer);
    alert("åˆ†äº«é€™å€‹ ID çµ¦æœ‹å‹é€£ç·šï¼\n\n" + id);
    const answer = await wait(id);
    await peer.setRemoteDescription(answer);
  } else {
    const otherID = prompt("è«‹è¼¸å…¥å°æ–¹æä¾›çš„ ID");
    const offer = await get(otherID);
    await peer.setRemoteDescription(offer);
    const answer = await peer.createAnswer();
    await peer.setLocalDescription(answer);
    await post(answer, otherID);
  }
}

peer.onicecandidate = e => {
  if (e.candidate) return;
};

async function post(data, id = '') {
  const res = await fetch(SIGNAL_URL + '/' + id, {
    method: 'POST',
    body: JSON.stringify(data)
  });
  return await res.text();
}

async function get(id) {
  const res = await fetch(SIGNAL_URL + '/' + id);
  return await res.json();
}

async function wait(id) {
  let data = null;
  while (!data) {
    await new Promise(r => setTimeout(r, 1000));
    const res = await fetch(SIGNAL_URL + '/' + id);
    if (res.status === 200) data = await res.json();
  }
  return data;
}

// å•Ÿå‹•ï¼é¸æ“‡ä¸»æ©Ÿ or åŠ å…¥
connect(confirm("ä½ è¦ç•¶æˆ¿ä¸»å—ï¼Ÿé» 'ç¢ºå®š' å‰‡å»ºç«‹é€£ç·šï¼Œé» 'å–æ¶ˆ' å‰‡åŠ å…¥æˆ¿é–“"));
</script>
</body>
</html>
